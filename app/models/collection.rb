require 'csv'

# Generated by hyrax:models
class Collection < ActiveFedora::Base
  include ::Hyrax::CollectionBehavior

  validate :auto_fill_fields, on: :create
  # You can replace these metadata if they're not suitable
  validates :license, presence: { message: 'Your collection must have rights.' }
  validates :identifier, presence: { message: 'Your collection must have an identifier.' }
  validates :rights_holder, presence: { message: 'Your collection must have a rights holder.' }


  # The include (include ::Hyrax::BasicMetadata) must appear
  # below custom predicate definitions as of Hyrax 2.0.0
  include ::Hyrax::BasicMetadata

  self.indexer = Hyrax::CollectionWithBasicMetadataIndexer

  # Add members using the members association.
  def add_members(new_member_ids)
    return if new_member_ids.nil? || new_member_ids.empty?
    items = ActiveFedora::Base.find(new_member_ids)
    items.each do |item|
      item.license = self.license
      item.bibliographic_citation = self.bibliographic_citation
      item.save
    end
    members << items
  end

  def export_csv
    headers = ["Collection Identifier", "Item Identifier", "Title", "Circa",
               "Start Date", "End Data", "Description", "Subject", "Type",
               "Medium", "Format", "Creator", "Source", "Location of Originals",
               "Language", "Coverage", "Tags", "Related URL", "Contributor",
               "Rights", "Rights Holder", "Bibliographic Citation"]
    ::CSV.generate(headers: true) do |csv|
      csv << headers
      member_objects.each do |item|
        csv << item.csv_values
      end
    end
  end

  private
    def auto_fill_fields
      license = "Permission to publish material from the "
      license += self.title.first || String.new
      license += " must be obtained from University Libraries Special Collections, Virginia Tech."
      self.license = license
      self.rights_holder = "Special Collections, University Libraries, Virginia Tech"
      bibli_citation = "Researchers wishing to cite this collection should include the following information: - Special Collections, Virginia Polytechnic Institute and State University, Blacksburg, Va."
      self.bibliographic_citation = bibli_citation
    end
end
